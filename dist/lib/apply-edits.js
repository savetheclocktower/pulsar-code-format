"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.applyEditsToUnopenBuffer = exports.applyEditsToOpenEditor = void 0;
const MARKER_LAYERS_FOR_EDITORS = new WeakMap();
const MARKER_LAYERS_FOR_BUFFERS = new WeakMap();
function findOrCreateMarkerLayerForEditor(editor) {
    let layer = MARKER_LAYERS_FOR_EDITORS.get(editor);
    if (!layer) {
        layer = editor.addMarkerLayer({ maintainHistory: true });
        MARKER_LAYERS_FOR_EDITORS.set(editor, layer);
    }
    return layer;
}
function findOrCreateMarkerLayerForBuffer(buffer) {
    let layer = MARKER_LAYERS_FOR_BUFFERS.get(buffer);
    if (!layer) {
        layer = buffer.addMarkerLayer({ maintainHistory: true });
        MARKER_LAYERS_FOR_BUFFERS.set(buffer, layer);
    }
    return layer;
}
// Applies the given edits to a `TextEditor` instance that is present in the
// workspace.
function applyEditsToOpenEditor(editor, edits) {
    let buffer = editor.getBuffer();
    const checkpoint = buffer.createCheckpoint();
    try {
        let layer = findOrCreateMarkerLayerForEditor(editor);
        let markerMap = new Map();
        for (let edit of edits) {
            let marker = layer.markBufferRange(edit.oldRange);
            markerMap.set(edit, marker);
        }
        for (let edit of edits) {
            let marker = markerMap.get(edit);
            if (!marker)
                throw new Error(`Marker missing range!`);
            buffer.setTextInRange(marker.getBufferRange(), edit.newText);
        }
        buffer.groupChangesSinceCheckpoint(checkpoint);
        return checkpoint;
    }
    catch (err) {
        buffer.revertToCheckpoint(checkpoint);
        throw err;
    }
}
exports.applyEditsToOpenEditor = applyEditsToOpenEditor;
// Applies the given edits to a `TextBuffer` instance representing a file
// that is not currently open in the workspace.
function applyEditsToUnopenBuffer(buffer, edits) {
    const checkpoint = buffer.createCheckpoint();
    try {
        let layer = findOrCreateMarkerLayerForBuffer(buffer);
        let markerMap = new Map();
        for (let edit of edits) {
            let marker = layer.markRange(edit.oldRange);
            markerMap.set(edit, marker);
        }
        for (let edit of edits) {
            let marker = markerMap.get(edit);
            if (!marker)
                throw new Error(`Marker missing range!`);
            buffer.setTextInRange(marker.getRange(), edit.newText);
        }
        buffer.groupChangesSinceCheckpoint(checkpoint);
        return checkpoint;
    }
    catch (err) {
        buffer.revertToCheckpoint(checkpoint);
        throw err;
    }
}
exports.applyEditsToUnopenBuffer = applyEditsToUnopenBuffer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbHktZWRpdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvYXBwbHktZWRpdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR0EsTUFBTSx5QkFBeUIsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBQ2hELE1BQU0seUJBQXlCLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUVoRCxTQUFTLGdDQUFnQyxDQUFDLE1BQWtCO0lBQzFELElBQUksS0FBSyxHQUFHLHlCQUF5QixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDWCxLQUFLLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELHlCQUF5QixDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsZ0NBQWdDLENBQUMsTUFBa0I7SUFDMUQsSUFBSSxLQUFLLEdBQUcseUJBQXlCLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNYLEtBQUssR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekQseUJBQXlCLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBRUQsNEVBQTRFO0FBQzVFLGFBQWE7QUFDYixTQUFnQixzQkFBc0IsQ0FBQyxNQUFrQixFQUFFLEtBQWlCO0lBQzFFLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNoQyxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUM3QyxJQUFJLENBQUM7UUFDSCxJQUFJLEtBQUssR0FBRyxnQ0FBZ0MsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyRCxJQUFJLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzFCLEtBQUssSUFBSSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7WUFDdkIsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbEQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDOUIsQ0FBQztRQUVELEtBQUssSUFBSSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7WUFDdkIsSUFBSSxNQUFNLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsTUFBTTtnQkFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDdEQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFDRCxNQUFNLENBQUMsMkJBQTJCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDL0MsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEMsTUFBTSxHQUFHLENBQUM7SUFDWixDQUFDO0FBQ0gsQ0FBQztBQXRCRCx3REFzQkM7QUFFRCx5RUFBeUU7QUFDekUsK0NBQStDO0FBQy9DLFNBQWdCLHdCQUF3QixDQUFDLE1BQWtCLEVBQUUsS0FBaUI7SUFDNUUsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDN0MsSUFBSSxDQUFDO1FBQ0gsSUFBSSxLQUFLLEdBQUcsZ0NBQWdDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckQsSUFBSSxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMxQixLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ3ZCLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzVDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFFRCxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ3ZCLElBQUksTUFBTSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLE1BQU07Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBQ3RELE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBQ0QsTUFBTSxDQUFDLDJCQUEyQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9DLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2IsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sR0FBRyxDQUFDO0lBQ1osQ0FBQztBQUNILENBQUM7QUFyQkQsNERBcUJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEJ1ZmZlciwgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nO1xuaW1wb3J0IHsgVGV4dEVkaXQgfSBmcm9tIFwiYXRvbS1pZGUtYmFzZVwiO1xuXG5jb25zdCBNQVJLRVJfTEFZRVJTX0ZPUl9FRElUT1JTID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IE1BUktFUl9MQVlFUlNfRk9SX0JVRkZFUlMgPSBuZXcgV2Vha01hcCgpO1xuXG5mdW5jdGlvbiBmaW5kT3JDcmVhdGVNYXJrZXJMYXllckZvckVkaXRvcihlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgbGV0IGxheWVyID0gTUFSS0VSX0xBWUVSU19GT1JfRURJVE9SUy5nZXQoZWRpdG9yKTtcbiAgaWYgKCFsYXllcikge1xuICAgIGxheWVyID0gZWRpdG9yLmFkZE1hcmtlckxheWVyKHsgbWFpbnRhaW5IaXN0b3J5OiB0cnVlIH0pO1xuICAgIE1BUktFUl9MQVlFUlNfRk9SX0VESVRPUlMuc2V0KGVkaXRvciwgbGF5ZXIpO1xuICB9XG4gIHJldHVybiBsYXllcjtcbn1cblxuZnVuY3Rpb24gZmluZE9yQ3JlYXRlTWFya2VyTGF5ZXJGb3JCdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gIGxldCBsYXllciA9IE1BUktFUl9MQVlFUlNfRk9SX0JVRkZFUlMuZ2V0KGJ1ZmZlcik7XG4gIGlmICghbGF5ZXIpIHtcbiAgICBsYXllciA9IGJ1ZmZlci5hZGRNYXJrZXJMYXllcih7IG1haW50YWluSGlzdG9yeTogdHJ1ZSB9KTtcbiAgICBNQVJLRVJfTEFZRVJTX0ZPUl9CVUZGRVJTLnNldChidWZmZXIsIGxheWVyKTtcbiAgfVxuICByZXR1cm4gbGF5ZXI7XG59XG5cbi8vIEFwcGxpZXMgdGhlIGdpdmVuIGVkaXRzIHRvIGEgYFRleHRFZGl0b3JgIGluc3RhbmNlIHRoYXQgaXMgcHJlc2VudCBpbiB0aGVcbi8vIHdvcmtzcGFjZS5cbmV4cG9ydCBmdW5jdGlvbiBhcHBseUVkaXRzVG9PcGVuRWRpdG9yKGVkaXRvcjogVGV4dEVkaXRvciwgZWRpdHM6IFRleHRFZGl0W10pIHtcbiAgbGV0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgY2hlY2twb2ludCA9IGJ1ZmZlci5jcmVhdGVDaGVja3BvaW50KCk7XG4gIHRyeSB7XG4gICAgbGV0IGxheWVyID0gZmluZE9yQ3JlYXRlTWFya2VyTGF5ZXJGb3JFZGl0b3IoZWRpdG9yKTtcbiAgICBsZXQgbWFya2VyTWFwID0gbmV3IE1hcCgpO1xuICAgIGZvciAobGV0IGVkaXQgb2YgZWRpdHMpIHtcbiAgICAgIGxldCBtYXJrZXIgPSBsYXllci5tYXJrQnVmZmVyUmFuZ2UoZWRpdC5vbGRSYW5nZSk7XG4gICAgICBtYXJrZXJNYXAuc2V0KGVkaXQsIG1hcmtlcik7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgZWRpdCBvZiBlZGl0cykge1xuICAgICAgbGV0IG1hcmtlciA9IG1hcmtlck1hcC5nZXQoZWRpdCk7XG4gICAgICBpZiAoIW1hcmtlcikgdGhyb3cgbmV3IEVycm9yKGBNYXJrZXIgbWlzc2luZyByYW5nZSFgKTtcbiAgICAgIGJ1ZmZlci5zZXRUZXh0SW5SYW5nZShtYXJrZXIuZ2V0QnVmZmVyUmFuZ2UoKSwgZWRpdC5uZXdUZXh0KTtcbiAgICB9XG4gICAgYnVmZmVyLmdyb3VwQ2hhbmdlc1NpbmNlQ2hlY2twb2ludChjaGVja3BvaW50KTtcbiAgICByZXR1cm4gY2hlY2twb2ludDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgYnVmZmVyLnJldmVydFRvQ2hlY2twb2ludChjaGVja3BvaW50KTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuLy8gQXBwbGllcyB0aGUgZ2l2ZW4gZWRpdHMgdG8gYSBgVGV4dEJ1ZmZlcmAgaW5zdGFuY2UgcmVwcmVzZW50aW5nIGEgZmlsZVxuLy8gdGhhdCBpcyBub3QgY3VycmVudGx5IG9wZW4gaW4gdGhlIHdvcmtzcGFjZS5cbmV4cG9ydCBmdW5jdGlvbiBhcHBseUVkaXRzVG9Vbm9wZW5CdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyLCBlZGl0czogVGV4dEVkaXRbXSkge1xuICBjb25zdCBjaGVja3BvaW50ID0gYnVmZmVyLmNyZWF0ZUNoZWNrcG9pbnQoKTtcbiAgdHJ5IHtcbiAgICBsZXQgbGF5ZXIgPSBmaW5kT3JDcmVhdGVNYXJrZXJMYXllckZvckJ1ZmZlcihidWZmZXIpO1xuICAgIGxldCBtYXJrZXJNYXAgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChsZXQgZWRpdCBvZiBlZGl0cykge1xuICAgICAgbGV0IG1hcmtlciA9IGxheWVyLm1hcmtSYW5nZShlZGl0Lm9sZFJhbmdlKTtcbiAgICAgIG1hcmtlck1hcC5zZXQoZWRpdCwgbWFya2VyKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBlZGl0IG9mIGVkaXRzKSB7XG4gICAgICBsZXQgbWFya2VyID0gbWFya2VyTWFwLmdldChlZGl0KTtcbiAgICAgIGlmICghbWFya2VyKSB0aHJvdyBuZXcgRXJyb3IoYE1hcmtlciBtaXNzaW5nIHJhbmdlIWApO1xuICAgICAgYnVmZmVyLnNldFRleHRJblJhbmdlKG1hcmtlci5nZXRSYW5nZSgpLCBlZGl0Lm5ld1RleHQpO1xuICAgIH1cbiAgICBidWZmZXIuZ3JvdXBDaGFuZ2VzU2luY2VDaGVja3BvaW50KGNoZWNrcG9pbnQpO1xuICAgIHJldHVybiBjaGVja3BvaW50O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBidWZmZXIucmV2ZXJ0VG9DaGVja3BvaW50KGNoZWNrcG9pbnQpO1xuICAgIHRocm93IGVycjtcbiAgfVxufVxuIl19